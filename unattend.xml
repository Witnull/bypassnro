<?xml version="1.0" encoding="utf-8"?>
<unattend xmlns="urn:schemas-microsoft-com:unattend" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State">

	<!-- 
	================================================================
	WINDOWS PE PASS
	This pass runs *during* the initial Windows Setup (WinPE), 
	before the OS is installed. It's the correct place for setup
	modifications, like bypassing hardware checks.
	================================================================
	-->
	<settings pass="windowsPE">
		<component name="Microsoft-Windows-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
			<RunSynchronous>
				<RunSynchronousCommand wcm:action="add">
					<Order>1</Order>
					<Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassTPMCheck /t REG_DWORD /d 1 /f</Path>
					<Description>Bypass TPM 2.0 Check</Description>
				</RunSynchronousCommand>
				<RunSynchronousCommand wcm:action="add">
					<Order>2</Order>
					<Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassSecureBootCheck /t REG_DWORD /d 1 /f</Path>
					<Description>Bypass Secure Boot Check</Description>
				</RunSynchronousCommand>
				<RunSynchronousCommand wcm:action="add">
					<Order>3</Order>
					<Path>reg.exe add "HKLM\SYSTEM\Setup\LabConfig" /v BypassRAMCheck /t REG_DWORD /d 1 /f</Path>
					<Description>Bypass RAM Check</Description>
				</RunSynchronousCommand>
			</RunSynchronous>
		</component>
	</settings>

	<!-- 
	================================================================
	SPECIALIZE PASS
	This pass runs *before* the OOBE (Out-of-Box Experience).
	It's used for system-wide settings (HKLM), machine policies,
	and modifying the 'Default User' profile (the template for new users).
	================================================================
	-->
	<settings pass="specialize">
		<component name="Microsoft-Windows-Deployment" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
			<RunSynchronous>
				<!-- Order 1: Set password maximum age to unlimited -->
				<RunSynchronousCommand wcm:action="add">
					<Order>1</Order>
					<Path>net.exe accounts /maxpwage:UNLIMITED</Path>
					<Description>Disable password expiration policy</Description>
				</RunSynchronousCommand>

				<!-- Order 2: Enable long file paths system-wide -->
				<RunSynchronousCommand wcm:action="add">
					<Order>2</Order>
					<Path>reg.exe add "HKLM\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f</Path>
					<Description>Allow file paths longer than 260 characters</Description>
				</RunSynchronousCommand>

				<!-- Order 3: Remove 'Authenticated Users' from C:\ root permissions. -->
				<RunSynchronousCommand wcm:action="add">
					<Order>3</Order>
					<Path>icacls.exe C:\ /remove:g "*S-1-5-11"</Path>
					<Description>Harden C:\ permissions by removing 'Authenticated Users' (SID S-1-5-11)</Description>
				</RunSynchronousCommand>

				<!-- Order 4: Enable success/failure auditing for 'Process Creation' events -->
				<RunSynchronousCommand wcm:action="add">
					<Order>4</Order>
					<Path>auditpol.exe /set /subcategory:"{0CCE922B-69AE-11D9-BED3-505054503030}" /success:enable /failure:enable</Path>
					<Description>Enable 'Process Creation' auditing (Event ID 4688)</Description>
				</RunSynchronousCommand>

				<!-- Order 5: Enable command line logging for process creation events -->
				<RunSynchronousCommand wcm:action="add">
					<Order>5</Order>
					<Path>reg.exe add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit" /v ProcessCreationIncludeCmdLine_Enabled /t REG_DWORD /d 1 /f</Path>
					<Description>Include command line text in process creation audit logs</Description>
				</RunSynchronousCommand>

				<!-- Order 6: Set PowerShell execution policy to RemoteSigned for the machine -->
				<RunSynchronousCommand wcm:action="add">
					<Order>6</Order>
					<Path>powershell.exe -Command "Set-ExecutionPolicy -Scope 'LocalMachine' -ExecutionPolicy 'RemoteSigned' -Force"</Path>
					<Description>Allow local scripts and signed remote scripts to run in PowerShell</Description>
				</RunSynchronousCommand>

				<!-- Order 7: Prevent automatic device encryption (BitLocker) -->
				<RunSynchronousCommand wcm:action="add">
					<Order>7</Order>
					<Path>reg.exe add "HKLM\SYSTEM\CurrentControlSet\Control\BitLocker" /v "PreventDeviceEncryption" /t REG_DWORD /d 1 /f</Path>
					<Description>Disable automatic BitLocker device encryption on supported hardware</Description>
				</RunSynchronousCommand>
				
				<!-- 
				================================================================
				DEFAULT USER HIVE MODIFICATIONS (FIXED)
				This section now correctly loads the NTUSER.DAT file,
				modifies it, and then unloads it.
				================================================================
				-->

				<!-- Order 8: Load the Default User registry hive -->
				<RunSynchronousCommand wcm:action="add">
					<Order>8</Order>
					<Path>reg.exe load "HKU\DefaultUser" "C:\Users\Default\NTUSER.DAT"</Path>
					<Description>Load Default User hive for editing</Description>
				</RunSynchronousCommand>

				<!-- Order 9: Show file extensions (e.g., .txt, .exe) for new users -->
				<RunSynchronousCommand wcm:action="add">
					<Order>9</Order>
					<Path>reg.exe add "HKU\DefaultUser\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" /v "HideFileExt" /t REG_DWORD /d 0 /f</Path>
					<Description>Show file extensions for new users by default</Description>
				</RunSynchronousCommand>

				<!-- Order 10: Show hidden files and folders for new users -->
				<RunSynchronousCommand wcm:action="add">
					<Order>10</Order>
					<Path>reg.exe add "HKU\DefaultUser\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" /v "Hidden" /t REG_DWORD /d 1 /f</Path>
					<Description>Show hidden files for new users by default</Description>
				</RunSynchronousCommand>

				<!-- Order 12: Enable 'End Task' on taskbar right-click for new users (Win11 feature) -->
				<RunSynchronousCommand wcm:action="add">
					<Order>12</Order>
					<Path>reg.exe add "HKU\DefaultUser\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced\TaskbarDeveloperSettings" /v TaskbarEndTask /t REG_DWORD /d 1 /f</Path>
					<Description>Enable 'End Task' context menu on taskbar for new users</Description>
				</RunSynchronousCommand>

				<!-- Order 13: Unload the Default User registry hive to save changes -->
				<RunSynchronousCommand wcm:action="add">
					<Order>13</Order>
					<Path>reg.exe unload "HKU\DefaultUser"</Path>
					<Description>Unload Default User hive to save changes</Description>
				</RunSynchronousCommand>

				<!-- Order 14: Allow blank password logons -->
				<RunSynchronousCommand wcm:action="add">
					<Order>14</Order>
					<Path>reg.exe add "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v LimitBlankPasswordUse /t REG_DWORD /d 0 /f</Path>
					<Description>Allow logging in with a blank password</Description>
				</RunSynchronousCommand>
				
				<!-- Order 15: Disable any pending AutoLogon counts -->
				<RunSynchronousCommand wcm:action="add">
					<Order>15</Order>
					<Path>powershell.exe -Command "Set-ItemProperty -LiteralPath 'Registry::HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon' -Name 'AutoLogonCount' -Type 'DWord' -Force -Value 0"</Path>
					<Description>Disable AutoLogonCount</Description>
				</RunSynchronousCommand>
			</RunSynchronous>
		</component>
	</settings>

	<!-- 
	================================================================
	OOBE SYSTEM PASS
	This pass runs *during* the OOBE. The FirstLogonCommands here run 
	*as the new user* the very first time they log in. This is the 
	correct place for user-specific settings (HKCU).
	================================================================
	-->
	<settings pass="oobeSystem">
		<component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
			<UserAccounts>
				<LocalAccounts>
					<!-- This block will be filled in by your batch script -->
					<LocalAccount wcm:action="add">
						<Name>Admin</Name>
						<Group>Administrators</Group>
						<Password>
							<Value>pass</Value>
							<PlainText>true</PlainText>
						</Password>
					</LocalAccount>
				</LocalAccounts>
			</UserAccounts>
			<OOBE>
				<HideEULAPage>true</HideEULAPage>
				<HideOEMRegistrationScreen>true</HideOEMRegistrationScreen>
				<HideOnlineAccountScreens>true</HideOnlineAccountScreens>
				<HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
				<ProtectYourPC>3</ProtectYourPC>
			</OOBE>

			<!-- 
			================================================================
			FIRST LOGON COMMANDS
			These run *after* setup is complete and the new user logs in.
			================================================================
			-->
			<FirstLogonCommands>

				<!-- Order 1: Restore Windows 10 context menu (disables Win11 full context menu) -->
				<SynchronousCommand wcm:action="add">
					<Order>1</Order>
					<CommandLine>reg.exe add "HKCU\Software\Classes\CLSID\{86ca1aa0-34aa-4e8b-a509-50c905bae2a2}\InprocServer32" /ve /f</CommandLine>
					<Description>Restore classic right-click context menu in Windows 11</Description>
				</SynchronousCommand>

				<!-- Order 2: Set File Explorer to open to 'This PC' instead of 'Home' -->
				<SynchronousCommand wcm:action="add">
					<Order>2</Order>
					<CommandLine>powershell.exe -Command "Set-ItemProperty -LiteralPath 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name 'LaunchTo' -Type 'DWord' -Value 1"</CommandLine>
					<Description>Set File Explorer to open to 'This PC'</Description>
				</SynchronousCommand>

				<!-- Order 3: Set Taskbar search to 'Search icon only' -->
				<SynchronousCommand wcm:action="add">
					<Order>3</Order>
					<CommandLine>powershell.exe -Command "Set-ItemProperty -LiteralPath 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\Search' -Name 'SearchboxTaskbarMode' -Type 'DWord' -Value 1"</CommandLine>
					<Description>Set taskbar search icon to 'Icon only'</Description>
				</SynchronousCommand>

				<!-- 
				  Order 4: Final cleanup. Remove the unattended setup file.
				  This runs last to erase the evidence of the setup (including the plain-text password).
				-->
				<SynchronousCommand wcm:action="add">
					<Order>4</Order>
					<CommandLine>powershell.exe -Command "Remove-Item -LiteralPath @('C:\Windows\Panther\unattend.xml', 'C:\Windows\Panther\unattend-original.xml', 'C:\Windows\Setup\Scripts\Wifi.xml') -Force -ErrorAction 'SilentlyContinue'"</CommandLine>
					<Description>Cleanup setup files</Description>
				</SynchronousCommand>

			</FirstLogonCommands>
		</component>
	</settings>
</unattend>
